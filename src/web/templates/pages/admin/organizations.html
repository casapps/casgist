{{define "content"}}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-base-content">Organization Management</h1>
            <p class="text-base-content/70 mt-1">Manage organizations and their members</p>
        </div>
        <div class="mt-4 sm:mt-0 space-x-2">
            <button onclick="exportOrganizations()" class="btn btn-ghost">
                <i class="fas fa-download mr-2"></i>
                Export
            </button>
            <a href="/admin/organizations/new" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i>
                Create Organization
            </a>
        </div>
    </div>
    
    <!-- Filters and Search -->
    <div class="card bg-base-200">
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Search -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Search Organizations</span>
                    </label>
                    <div class="input-group">
                        <input type="text" id="search-input" placeholder="Name or description..." class="input input-bordered flex-1" />
                        <button onclick="searchOrganizations()" class="btn btn-square">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Status Filter -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Status</span>
                    </label>
                    <select id="status-filter" class="select select-bordered" onchange="filterOrganizations()">
                        <option value="">All Organizations</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                
                <!-- Results per page -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Per Page</span>
                    </label>
                    <select id="limit-filter" class="select select-bordered" onchange="filterOrganizations()">
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Organization Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="stat bg-base-200 rounded-box">
            <div class="stat-figure text-primary">
                <i class="fas fa-building text-2xl"></i>
            </div>
            <div class="stat-title">Total Organizations</div>
            <div class="stat-value" id="total-orgs">{{.Stats.TotalOrganizations}}</div>
            <div class="stat-desc">Registered organizations</div>
        </div>
        
        <div class="stat bg-base-200 rounded-box">
            <div class="stat-figure text-success">
                <i class="fas fa-check-circle text-2xl"></i>
            </div>
            <div class="stat-title">Active Organizations</div>
            <div class="stat-value" id="active-orgs">{{.Stats.ActiveOrganizations}}</div>
            <div class="stat-desc">{{.Stats.ActivePercentage}}% of total</div>
        </div>
        
        <div class="stat bg-base-200 rounded-box">
            <div class="stat-figure text-info">
                <i class="fas fa-users text-2xl"></i>
            </div>
            <div class="stat-title">Total Members</div>
            <div class="stat-value" id="total-members">{{.Stats.TotalMembers}}</div>
            <div class="stat-desc">Across all organizations</div>
        </div>
        
        <div class="stat bg-base-200 rounded-box">
            <div class="stat-figure text-accent">
                <i class="fas fa-file-code text-2xl"></i>
            </div>
            <div class="stat-title">Organization Gists</div>
            <div class="stat-value" id="org-gists">{{.Stats.OrganizationGists}}</div>
            <div class="stat-desc">Created by organizations</div>
        </div>
    </div>
    
    <!-- Organizations Grid/List -->
    <div class="card bg-base-200">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h2 class="card-title">Organizations</h2>
                <div class="space-x-2">
                    <div class="join">
                        <button onclick="setView('grid')" class="btn btn-sm join-item" id="grid-view-btn">
                            <i class="fas fa-th"></i>
                        </button>
                        <button onclick="setView('list')" class="btn btn-sm join-item btn-active" id="list-view-btn">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="loading" class="flex justify-center py-8">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
            
            <!-- Organizations Grid View -->
            <div id="organizations-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" style="display: none;">
                <!-- Organizations will be loaded here -->
            </div>
            
            <!-- Organizations List View -->
            <div id="organizations-list" class="overflow-x-auto" style="display: none;">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>Organization</th>
                            <th>Members</th>
                            <th>Gists</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="organizations-tbody">
                        <!-- Organizations will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div id="pagination" class="flex justify-center mt-6" style="display: none;">
                <div class="join">
                    <button id="prev-btn" class="join-item btn btn-sm" onclick="changePage(-1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div id="page-info" class="join-item btn btn-sm btn-disabled">
                        Page 1 of 1
                    </div>
                    <button id="next-btn" class="join-item btn btn-sm" onclick="changePage(1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentLimit = 20;
let currentSearch = '';
let currentStatus = '';
let currentView = 'list';

// Load organizations on page load
document.addEventListener('DOMContentLoaded', function() {
    loadOrganizations();
});

async function loadOrganizations() {
    try {
        showLoading(true);
        
        const params = new URLSearchParams({
            page: currentPage,
            limit: currentLimit,
            search: currentSearch,
            status: currentStatus
        });
        
        const response = await fetch(`/api/v1/admin/organizations?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            displayOrganizations(data.organizations, data.pagination);
        } else {
            showToast('Error loading organizations: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error loading organizations: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function displayOrganizations(organizations, pagination) {
    if (currentView === 'grid') {
        displayOrganizationsGrid(organizations);
    } else {
        displayOrganizationsList(organizations);
    }
    
    updatePagination(pagination);
    document.getElementById('pagination').style.display = 'flex';
}

function displayOrganizationsGrid(organizations) {
    const grid = document.getElementById('organizations-grid');
    grid.innerHTML = '';
    
    organizations.forEach(org => {
        const card = createOrganizationCard(org);
        grid.appendChild(card);
    });
    
    document.getElementById('organizations-grid').style.display = 'grid';
    document.getElementById('organizations-list').style.display = 'none';
}

function displayOrganizationsList(organizations) {
    const tbody = document.getElementById('organizations-tbody');
    tbody.innerHTML = '';
    
    organizations.forEach(org => {
        const row = createOrganizationRow(org);
        tbody.appendChild(row);
    });
    
    document.getElementById('organizations-grid').style.display = 'none';
    document.getElementById('organizations-list').style.display = 'block';
}

function createOrganizationCard(org) {
    const card = document.createElement('div');
    card.className = 'card bg-base-100 shadow-md hover:shadow-lg transition-shadow';
    
    const statusBadge = org.is_active ? 
        '<span class="badge badge-success">Active</span>' : 
        '<span class="badge badge-error">Inactive</span>';
    
    card.innerHTML = `
        <div class="card-body">
            <div class="flex items-start justify-between">
                <div class="flex items-center space-x-3">
                    <div class="avatar">
                        <div class="w-12 h-12 rounded-lg bg-primary/20 flex items-center justify-center">
                            <i class="fas fa-building text-primary text-xl"></i>
                        </div>
                    </div>
                    <div>
                        <h3 class="card-title text-lg">${org.name}</h3>
                        <p class="text-sm text-base-content/70">@${org.username}</p>
                    </div>
                </div>
                ${statusBadge}
            </div>
            
            ${org.description ? `<p class="text-sm text-base-content/80 mt-2">${org.description}</p>` : ''}
            
            <div class="grid grid-cols-3 gap-4 mt-4">
                <div class="text-center">
                    <div class="text-lg font-bold">${org.member_count || 0}</div>
                    <div class="text-xs text-base-content/70">Members</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold">${org.gist_count || 0}</div>
                    <div class="text-xs text-base-content/70">Gists</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold">${org.repo_count || 0}</div>
                    <div class="text-xs text-base-content/70">Repos</div>
                </div>
            </div>
            
            <div class="card-actions justify-end mt-4">
                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-ghost btn-sm">
                        <i class="fas fa-ellipsis-v"></i>
                    </label>
                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                        <li><a onclick="viewOrganization('${org.id}')"><i class="fas fa-eye mr-2"></i>View Profile</a></li>
                        <li><a onclick="editOrganization('${org.id}')"><i class="fas fa-edit mr-2"></i>Edit Organization</a></li>
                        <li><a onclick="manageMembers('${org.id}')"><i class="fas fa-users mr-2"></i>Manage Members</a></li>
                        ${org.is_active ? 
                            `<li><a onclick="deactivateOrganization('${org.id}')" class="text-warning"><i class="fas fa-pause mr-2"></i>Deactivate</a></li>` :
                            `<li><a onclick="activateOrganization('${org.id}')" class="text-success"><i class="fas fa-play mr-2"></i>Activate</a></li>`
                        }
                        <li><a onclick="deleteOrganization('${org.id}')" class="text-error"><i class="fas fa-trash mr-2"></i>Delete</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="text-xs text-base-content/50 mt-2">
                Created ${formatDate(org.created_at)}
            </div>
        </div>
    `;
    
    return card;
}

function createOrganizationRow(org) {
    const row = document.createElement('tr');
    row.dataset.orgId = org.id;
    
    const statusBadge = org.is_active ? 
        '<span class="badge badge-success">Active</span>' : 
        '<span class="badge badge-error">Inactive</span>';
    
    row.innerHTML = `
        <td>
            <div class="flex items-center space-x-3">
                <div class="avatar">
                    <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
                        <i class="fas fa-building text-primary"></i>
                    </div>
                </div>
                <div>
                    <div class="font-bold">${org.name}</div>
                    <div class="text-sm opacity-50">@${org.username}</div>
                    ${org.description ? `<div class="text-xs opacity-75">${org.description.substring(0, 50)}${org.description.length > 50 ? '...' : ''}</div>` : ''}
                </div>
            </div>
        </td>
        <td><span class="badge badge-ghost">${org.member_count || 0}</span></td>
        <td><span class="badge badge-ghost">${org.gist_count || 0}</span></td>
        <td>${statusBadge}</td>
        <td><span class="text-sm">${formatDate(org.created_at)}</span></td>
        <td>
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost btn-xs">
                    <i class="fas fa-ellipsis-v"></i>
                </label>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a onclick="viewOrganization('${org.id}')"><i class="fas fa-eye mr-2"></i>View Profile</a></li>
                    <li><a onclick="editOrganization('${org.id}')"><i class="fas fa-edit mr-2"></i>Edit Organization</a></li>
                    <li><a onclick="manageMembers('${org.id}')"><i class="fas fa-users mr-2"></i>Manage Members</a></li>
                    ${org.is_active ? 
                        `<li><a onclick="deactivateOrganization('${org.id}')" class="text-warning"><i class="fas fa-pause mr-2"></i>Deactivate</a></li>` :
                        `<li><a onclick="activateOrganization('${org.id}')" class="text-success"><i class="fas fa-play mr-2"></i>Activate</a></li>`
                    }
                    <li><a onclick="deleteOrganization('${org.id}')" class="text-error"><i class="fas fa-trash mr-2"></i>Delete</a></li>
                </ul>
            </div>
        </td>
    `;
    
    return row;
}

function updatePagination(pagination) {
    document.getElementById('page-info').textContent = `Page ${pagination.page} of ${pagination.total_pages}`;
    document.getElementById('prev-btn').disabled = pagination.page <= 1;
    document.getElementById('next-btn').disabled = pagination.page >= pagination.total_pages;
}

function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'flex' : 'none';
    document.getElementById('organizations-grid').style.display = show ? 'none' : (currentView === 'grid' ? 'grid' : 'none');
    document.getElementById('organizations-list').style.display = show ? 'none' : (currentView === 'list' ? 'block' : 'none');
    document.getElementById('pagination').style.display = show ? 'none' : 'flex';
}

function setView(view) {
    currentView = view;
    document.getElementById('grid-view-btn').classList.toggle('btn-active', view === 'grid');
    document.getElementById('list-view-btn').classList.toggle('btn-active', view === 'list');
    
    // Re-display with current data
    const grid = document.getElementById('organizations-grid');
    const list = document.getElementById('organizations-list');
    
    if (view === 'grid') {
        grid.style.display = 'grid';
        list.style.display = 'none';
    } else {
        grid.style.display = 'none';
        list.style.display = 'block';
    }
}

function changePage(direction) {
    currentPage += direction;
    loadOrganizations();
}

function searchOrganizations() {
    currentSearch = document.getElementById('search-input').value;
    currentPage = 1;
    loadOrganizations();
}

function filterOrganizations() {
    currentStatus = document.getElementById('status-filter').value;
    currentLimit = parseInt(document.getElementById('limit-filter').value);
    currentPage = 1;
    loadOrganizations();
}

function viewOrganization(orgId) {
    window.open(`/org/${orgId}`, '_blank');
}

function editOrganization(orgId) {
    window.location.href = `/admin/organizations/${orgId}/edit`;
}

function manageMembers(orgId) {
    window.location.href = `/admin/organizations/${orgId}/members`;
}

async function activateOrganization(orgId) {
    try {
        const response = await fetch(`/api/v1/admin/organizations/${orgId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': window.CasGists.csrf
            },
            body: JSON.stringify({ is_active: true })
        });
        
        if (response.ok) {
            showToast('Organization activated successfully', 'success');
            loadOrganizations();
        } else {
            const data = await response.json();
            showToast('Error activating organization: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error activating organization: ' + error.message, 'error');
    }
}

async function deactivateOrganization(orgId) {
    if (!confirm('Are you sure you want to deactivate this organization?')) return;
    
    try {
        const response = await fetch(`/api/v1/admin/organizations/${orgId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': window.CasGists.csrf
            },
            body: JSON.stringify({ is_active: false })
        });
        
        if (response.ok) {
            showToast('Organization deactivated successfully', 'success');
            loadOrganizations();
        } else {
            const data = await response.json();
            showToast('Error deactivating organization: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error deactivating organization: ' + error.message, 'error');
    }
}

async function deleteOrganization(orgId) {
    if (!confirm('Are you sure you want to delete this organization? This action cannot be undone.')) return;
    
    try {
        const response = await fetch(`/api/v1/admin/organizations/${orgId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRF-Token': window.CasGists.csrf
            }
        });
        
        if (response.ok) {
            showToast('Organization deleted successfully', 'success');
            loadOrganizations();
        } else {
            const data = await response.json();
            showToast('Error deleting organization: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error deleting organization: ' + error.message, 'error');
    }
}

function exportOrganizations() {
    // TODO: Implement organization export
    showToast('Export feature not yet implemented', 'info');
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} mb-2`;
    toast.innerHTML = `<span>${message}</span>`;
    
    const container = document.getElementById('toast-container');
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// Search on Enter key
document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchOrganizations();
    }
});
</script>
{{end}}