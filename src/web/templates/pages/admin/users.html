{{define "content"}}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-base-content">User Management</h1>
            <p class="text-base-content/70 mt-1">Manage user accounts and permissions</p>
        </div>
        <div class="mt-4 sm:mt-0 space-x-2">
            <button onclick="exportUsers()" class="btn btn-ghost">
                <i class="fas fa-download mr-2"></i>
                Export
            </button>
            <a href="/admin/users/new" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i>
                Add User
            </a>
        </div>
    </div>
    
    <!-- Filters and Search -->
    <div class="card bg-base-200">
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Search -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Search Users</span>
                    </label>
                    <div class="input-group">
                        <input type="text" id="search-input" placeholder="Username, email, or name..." class="input input-bordered flex-1" />
                        <button onclick="searchUsers()" class="btn btn-square">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Status Filter -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Status</span>
                    </label>
                    <select id="status-filter" class="select select-bordered" onchange="filterUsers()">
                        <option value="">All Users</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="admin">Administrators</option>
                    </select>
                </div>
                
                <!-- Date Range -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Registered</span>
                    </label>
                    <select id="date-filter" class="select select-bordered" onchange="filterUsers()">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
                
                <!-- Results per page -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Per Page</span>
                    </label>
                    <select id="limit-filter" class="select select-bordered" onchange="filterUsers()">
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="stat bg-base-200 rounded-box">
            <div class="stat-figure text-primary">
                <i class="fas fa-users text-2xl"></i>
            </div>
            <div class="stat-title">Total Users</div>
            <div class="stat-value" id="total-users">{{.Stats.TotalUsers}}</div>
            <div class="stat-desc">Registered accounts</div>
        </div>
        
        <div class="stat bg-base-200 rounded-box">
            <div class="stat-figure text-success">
                <i class="fas fa-user-check text-2xl"></i>
            </div>
            <div class="stat-title">Active Users</div>
            <div class="stat-value" id="active-users">{{.Stats.ActiveUsers}}</div>
            <div class="stat-desc">{{.Stats.ActivePercentage}}% of total</div>
        </div>
        
        <div class="stat bg-base-200 rounded-box">
            <div class="stat-figure text-warning">
                <i class="fas fa-shield-alt text-2xl"></i>
            </div>
            <div class="stat-title">Administrators</div>
            <div class="stat-value" id="admin-users">{{.Stats.AdminUsers}}</div>
            <div class="stat-desc">System administrators</div>
        </div>
        
        <div class="stat bg-base-200 rounded-box">
            <div class="stat-figure text-info">
                <i class="fas fa-calendar-plus text-2xl"></i>
            </div>
            <div class="stat-title">New This Month</div>
            <div class="stat-value" id="new-users">{{.Stats.NewThisMonth}}</div>
            <div class="stat-desc">Recent registrations</div>
        </div>
    </div>
    
    <!-- User Table -->
    <div class="card bg-base-200">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h2 class="card-title">Users</h2>
                <div class="space-x-2">
                    <div class="join">
                        <button onclick="selectAll()" class="btn btn-sm join-item">Select All</button>
                        <button onclick="bulkAction()" class="btn btn-sm join-item" disabled id="bulk-action-btn">
                            <i class="fas fa-cog mr-2"></i>
                            Actions
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="loading" class="flex justify-center py-8">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
            
            <!-- Users Table -->
            <div id="users-table" class="overflow-x-auto" style="display: none;">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th><input type="checkbox" class="checkbox" onchange="toggleSelectAll(this)" /></th>
                            <th>User</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Gists</th>
                            <th>Joined</th>
                            <th>Last Active</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div id="pagination" class="flex justify-center mt-6" style="display: none;">
                <div class="join">
                    <button id="prev-btn" class="join-item btn btn-sm" onclick="changePage(-1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div id="page-info" class="join-item btn btn-sm btn-disabled">
                        Page 1 of 1
                    </div>
                    <button id="next-btn" class="join-item btn btn-sm" onclick="changePage(1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Actions Modal -->
<dialog id="user-action-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg" id="modal-title">User Actions</h3>
        <div class="py-4" id="modal-content">
            <!-- Content will be populated dynamically -->
        </div>
        <div class="modal-action">
            <button class="btn" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="executeAction()" id="confirm-btn">Confirm</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Bulk Actions Modal -->
<dialog id="bulk-action-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Bulk Actions</h3>
        <div class="py-4">
            <p class="mb-4">Select an action to perform on <span id="selected-count">0</span> selected users:</p>
            <div class="space-y-2">
                <label class="cursor-pointer label">
                    <span class="label-text">Activate Users</span>
                    <input type="radio" name="bulk-action" value="activate" class="radio radio-primary" />
                </label>
                <label class="cursor-pointer label">
                    <span class="label-text">Deactivate Users</span>
                    <input type="radio" name="bulk-action" value="deactivate" class="radio radio-warning" />
                </label>
                <label class="cursor-pointer label">
                    <span class="label-text">Delete Users</span>
                    <input type="radio" name="bulk-action" value="delete" class="radio radio-error" />
                </label>
            </div>
        </div>
        <div class="modal-action">
            <button class="btn" onclick="closeBulkModal()">Cancel</button>
            <button class="btn btn-primary" onclick="executeBulkAction()">Execute</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
let currentPage = 1;
let currentLimit = 20;
let currentSearch = '';
let currentStatus = '';
let currentDate = '';
let selectedUsers = new Set();

// Load users on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
});

async function loadUsers() {
    try {
        showLoading(true);
        
        const params = new URLSearchParams({
            page: currentPage,
            limit: currentLimit,
            search: currentSearch,
            status: currentStatus,
            date: currentDate
        });
        
        const response = await fetch(`/api/v1/admin/users?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            displayUsers(data.users, data.pagination);
        } else {
            showToast('Error loading users: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error loading users: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function displayUsers(users, pagination) {
    const tbody = document.getElementById('users-tbody');
    tbody.innerHTML = '';
    
    users.forEach(user => {
        const row = createUserRow(user);
        tbody.appendChild(row);
    });
    
    updatePagination(pagination);
    document.getElementById('users-table').style.display = 'block';
    document.getElementById('pagination').style.display = 'flex';
}

function createUserRow(user) {
    const row = document.createElement('tr');
    row.dataset.userId = user.id;
    
    const statusBadge = user.is_active ? 
        '<span class="badge badge-success">Active</span>' : 
        '<span class="badge badge-error">Inactive</span>';
    
    const roleBadge = user.is_admin ? 
        '<span class="badge badge-warning">Admin</span>' : 
        '<span class="badge badge-ghost">User</span>';
    
    row.innerHTML = `
        <td><input type="checkbox" class="checkbox user-checkbox" value="${user.id}" onchange="toggleUser(this)" /></td>
        <td>
            <div class="flex items-center space-x-3">
                <div class="avatar">
                    <div class="mask mask-squircle w-12 h-12">
                        <img src="${user.avatar_url || '/static/img/default-avatar.png'}" alt="${user.username}" />
                    </div>
                </div>
                <div>
                    <div class="font-bold">${user.display_name || user.username}</div>
                    <div class="text-sm opacity-50">@${user.username}</div>
                </div>
            </div>
        </td>
        <td>
            <span class="text-sm">${user.email}</span>
            ${user.email_verified ? '<i class="fas fa-check-circle text-success ml-1" title="Verified"></i>' : '<i class="fas fa-times-circle text-error ml-1" title="Unverified"></i>'}
        </td>
        <td>${roleBadge}</td>
        <td>${statusBadge}</td>
        <td><span class="badge badge-ghost">${user.gist_count || 0}</span></td>
        <td><span class="text-sm">${formatDate(user.created_at)}</span></td>
        <td><span class="text-sm">${user.last_login_at ? formatDate(user.last_login_at) : 'Never'}</span></td>
        <td>
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost btn-xs">
                    <i class="fas fa-ellipsis-v"></i>
                </label>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a onclick="viewUser('${user.id}')"><i class="fas fa-eye mr-2"></i>View Profile</a></li>
                    <li><a onclick="editUser('${user.id}')"><i class="fas fa-edit mr-2"></i>Edit User</a></li>
                    <li><a onclick="resetPassword('${user.id}')"><i class="fas fa-key mr-2"></i>Reset Password</a></li>
                    ${user.is_active ? 
                        `<li><a onclick="banUser('${user.id}')" class="text-warning"><i class="fas fa-ban mr-2"></i>Ban User</a></li>` :
                        `<li><a onclick="unbanUser('${user.id}')" class="text-success"><i class="fas fa-check mr-2"></i>Unban User</a></li>`
                    }
                    ${!user.is_admin ? `<li><a onclick="deleteUser('${user.id}')" class="text-error"><i class="fas fa-trash mr-2"></i>Delete User</a></li>` : ''}
                </ul>
            </div>
        </td>
    `;
    
    return row;
}

function updatePagination(pagination) {
    document.getElementById('page-info').textContent = `Page ${pagination.page} of ${pagination.total_pages}`;
    document.getElementById('prev-btn').disabled = pagination.page <= 1;
    document.getElementById('next-btn').disabled = pagination.page >= pagination.total_pages;
}

function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'flex' : 'none';
    document.getElementById('users-table').style.display = show ? 'none' : 'block';
    document.getElementById('pagination').style.display = show ? 'none' : 'flex';
}

function changePage(direction) {
    currentPage += direction;
    loadUsers();
}

function searchUsers() {
    currentSearch = document.getElementById('search-input').value;
    currentPage = 1;
    loadUsers();
}

function filterUsers() {
    currentStatus = document.getElementById('status-filter').value;
    currentDate = document.getElementById('date-filter').value;
    currentLimit = parseInt(document.getElementById('limit-filter').value);
    currentPage = 1;
    loadUsers();
}

function toggleUser(checkbox) {
    const userId = checkbox.value;
    if (checkbox.checked) {
        selectedUsers.add(userId);
    } else {
        selectedUsers.delete(userId);
    }
    updateBulkActionButton();
}

function toggleSelectAll(checkbox) {
    const userCheckboxes = document.querySelectorAll('.user-checkbox');
    userCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        toggleUser(cb);
    });
}

function selectAll() {
    const userCheckboxes = document.querySelectorAll('.user-checkbox');
    userCheckboxes.forEach(cb => {
        cb.checked = true;
        toggleUser(cb);
    });
}

function updateBulkActionButton() {
    const btn = document.getElementById('bulk-action-btn');
    btn.disabled = selectedUsers.size === 0;
    if (selectedUsers.size > 0) {
        btn.innerHTML = `<i class="fas fa-cog mr-2"></i>Actions (${selectedUsers.size})`;
    } else {
        btn.innerHTML = `<i class="fas fa-cog mr-2"></i>Actions`;
    }
}

function bulkAction() {
    if (selectedUsers.size === 0) return;
    
    document.getElementById('selected-count').textContent = selectedUsers.size;
    document.getElementById('bulk-action-modal').showModal();
}

function viewUser(userId) {
    window.open(`/user/${userId}`, '_blank');
}

function editUser(userId) {
    window.location.href = `/admin/users/${userId}/edit`;
}

async function banUser(userId) {
    if (!confirm('Are you sure you want to ban this user?')) return;
    
    try {
        const response = await fetch(`/api/v1/admin/users/${userId}/ban`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': window.CasGists.csrf
            }
        });
        
        if (response.ok) {
            showToast('User banned successfully', 'success');
            loadUsers();
        } else {
            const data = await response.json();
            showToast('Error banning user: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error banning user: ' + error.message, 'error');
    }
}

async function unbanUser(userId) {
    try {
        const response = await fetch(`/api/v1/admin/users/${userId}/unban`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': window.CasGists.csrf
            }
        });
        
        if (response.ok) {
            showToast('User unbanned successfully', 'success');
            loadUsers();
        } else {
            const data = await response.json();
            showToast('Error unbanning user: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error unbanning user: ' + error.message, 'error');
    }
}

async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
    
    try {
        const response = await fetch(`/api/v1/admin/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRF-Token': window.CasGists.csrf
            }
        });
        
        if (response.ok) {
            showToast('User deleted successfully', 'success');
            loadUsers();
        } else {
            const data = await response.json();
            showToast('Error deleting user: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error deleting user: ' + error.message, 'error');
    }
}

function resetPassword(userId) {
    // TODO: Implement password reset
    showToast('Password reset feature not yet implemented', 'info');
}

function exportUsers() {
    // TODO: Implement user export
    showToast('Export feature not yet implemented', 'info');
}

function closeBulkModal() {
    document.getElementById('bulk-action-modal').close();
}

async function executeBulkAction() {
    const action = document.querySelector('input[name="bulk-action"]:checked')?.value;
    if (!action) {
        showToast('Please select an action', 'warning');
        return;
    }
    
    // TODO: Implement bulk actions
    showToast(`Bulk ${action} feature not yet implemented`, 'info');
    closeBulkModal();
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} mb-2`;
    toast.innerHTML = `<span>${message}</span>`;
    
    const container = document.getElementById('toast-container');
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// Search on Enter key
document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchUsers();
    }
});
</script>
{{end}}