{{define "admin_backup"}}
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backup Management - CasGists Admin</title>
    <link href="/static/css/tailwind.css" rel="stylesheet">
    <link href="/static/css/app.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="min-h-screen flex">
        <!-- Admin Sidebar -->
        <nav class="w-64 bg-gray-800 border-r border-gray-700">
            <div class="p-6">
                <h2 class="text-xl font-bold text-blue-400">CasGists Admin</h2>
            </div>
            <div class="px-4 space-y-2">
                <a href="/admin/dashboard" class="block px-4 py-2 rounded text-gray-300 hover:bg-gray-700">Dashboard</a>
                <a href="/admin/users" class="block px-4 py-2 rounded text-gray-300 hover:bg-gray-700">Users</a>
                <a href="/admin/organizations" class="block px-4 py-2 rounded text-gray-300 hover:bg-gray-700">Organizations</a>
                <a href="/admin/import" class="block px-4 py-2 rounded text-gray-300 hover:bg-gray-700">Platform Import</a>
                <a href="/admin/backup" class="block px-4 py-2 rounded bg-blue-600 text-white">Backup & Restore</a>
                <a href="/admin/settings" class="block px-4 py-2 rounded text-gray-300 hover:bg-gray-700">Settings</a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <div class="p-8">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold">Backup Management</h1>
                    <p class="text-gray-400 mt-2">Manage automatic backups and restore your CasGists data.</p>
                </div>

                <!-- Automatic Backups -->
                <div class="bg-gray-800 rounded-lg p-6 mb-8">
                    <h3 class="text-xl font-semibold mb-4">üîÑ Automatic Backups</h3>
                    <form id="backup-settings-form" class="space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label class="flex items-center mb-4">
                                    <input type="checkbox" name="enable_automatic" {{if .BackupSettings.Enabled}}checked{{end}} class="mr-3 w-5 h-5">
                                    <span class="font-medium">Enable automatic backups</span>
                                </label>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Schedule</label>
                                        <div class="flex space-x-2">
                                            <select name="frequency" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded">
                                                <option value="daily" {{if eq .BackupSettings.Frequency "daily"}}selected{{end}}>Daily</option>
                                                <option value="weekly" {{if eq .BackupSettings.Frequency "weekly"}}selected{{end}}>Weekly</option>
                                                <option value="monthly" {{if eq .BackupSettings.Frequency "monthly"}}selected{{end}}>Monthly</option>
                                            </select>
                                            <select name="time" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded">
                                                {{range $hour := .Hours}}
                                                <option value="{{$hour}}" {{if eq $.BackupSettings.Time $hour}}selected{{end}}>{{$hour}}:00</option>
                                                {{end}}
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Retention</label>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm text-gray-400">Keep</span>
                                            <input type="number" name="retention" value="{{.BackupSettings.Retention}}" min="1" max="30"
                                                   class="w-20 px-3 py-2 bg-gray-700 border border-gray-600 rounded">
                                            <span class="text-sm text-gray-400">backups</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="bg-blue-900 border border-blue-600 rounded-lg p-4">
                                    <h4 class="font-semibold text-blue-200 mb-2">Next Backup</h4>
                                    <p class="text-sm text-blue-300">{{.NextBackup.Format "Monday, Jan 2 at 3:04 PM"}} (in {{.NextBackupIn}})</p>
                                    <p class="text-xs text-blue-400 mt-2">
                                        Estimated Size: {{.EstimatedSize}} ‚Ä¢ Estimated Time: {{.EstimatedTime}}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-600 pt-6">
                            <label class="flex items-center mb-4">
                                <input type="checkbox" name="encrypt_backups" {{if .BackupSettings.Encrypted}}checked{{end}} class="mr-3 w-5 h-5">
                                <span class="font-medium">Encrypt backups (Required)</span>
                            </label>
                            <div class="bg-yellow-900 border border-yellow-600 rounded-lg p-4">
                                <p class="text-sm text-yellow-200">
                                    ‚ö†Ô∏è Backup encryption is required for security. The encryption key is automatically generated and stored securely.
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button type="submit" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded text-white">
                                Save Backup Settings
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Manual Backup -->
                <div class="bg-gray-800 rounded-lg p-6 mb-8">
                    <h3 class="text-xl font-semibold mb-4">üîß Manual Backup</h3>
                    <form id="manual-backup-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Backup Type</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="backup_type" value="full" checked class="mr-2">
                                    <span class="text-sm">Full server backup (all data, settings, users)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="backup_type" value="config" class="mr-2">
                                    <span class="text-sm">Configuration only (settings, no user data)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="backup_type" value="data" class="mr-2">
                                    <span class="text-sm">User data only (gists, users, no settings)</span>
                                </label>
                            </div>
                        </div>
                        <div class="bg-yellow-900 border border-yellow-600 rounded-lg p-4">
                            <p class="text-sm text-yellow-200">
                                ‚ö†Ô∏è Manual backups may take several minutes and will temporarily increase server load.
                            </p>
                        </div>
                        <div>
                            <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">
                                Create Backup Now
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Restore from Backup -->
                <div class="bg-gray-800 rounded-lg p-6 mb-8">
                    <h3 class="text-xl font-semibold mb-4">üîÑ Restore from Backup</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Select Backup</label>
                            <div class="flex space-x-2">
                                <input type="file" id="backup-file" accept=".tar.gz" 
                                       class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded">
                                <span class="text-gray-400 px-3 py-2">or</span>
                                <select id="backup-history" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded">
                                    <option value="">Select from history</option>
                                    {{range .BackupFiles}}
                                    <option value="{{.ID}}">{{.CreatedAt.Format "Jan 2, 2006"}} - {{.Size}} ({{.Status}})</option>
                                    {{end}}
                                </select>
                            </div>
                        </div>
                        <div class="bg-red-900 border border-red-600 rounded-lg p-4">
                            <h4 class="font-semibold text-red-200 mb-2">‚ö†Ô∏è DANGER</h4>
                            <p class="text-sm text-red-300">Restore will overwrite all current data! This action cannot be undone.</p>
                        </div>
                        <div>
                            <button id="restore-backup" class="px-6 py-2 bg-red-600 hover:bg-red-700 rounded text-white" disabled>
                                Restore Backup
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Backup History -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4">üìã Backup History</h3>
                    {{if .BackupFiles}}
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-600">
                                    <th class="text-left py-2">Date</th>
                                    <th class="text-left py-2">Size</th>
                                    <th class="text-left py-2">Duration</th>
                                    <th class="text-left py-2">Status</th>
                                    <th class="text-left py-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{range .BackupFiles}}
                                <tr class="border-b border-gray-700">
                                    <td class="py-2">{{.CreatedAt.Format "Jan 2, 2006 15:04"}}</td>
                                    <td class="py-2">{{.Size}}</td>
                                    <td class="py-2">{{.Duration}}</td>
                                    <td class="py-2">
                                        {{if eq .Status "success"}}
                                            <span class="px-2 py-1 bg-green-600 text-green-100 rounded text-xs">‚úÖ Success</span>
                                        {{else}}
                                            <span class="px-2 py-1 bg-red-600 text-red-100 rounded text-xs">‚ùå {{.Status}}</span>
                                        {{end}}
                                    </td>
                                    <td class="py-2 space-x-2">
                                        <button class="text-blue-400 hover:underline text-sm" onclick="downloadBackup('{{.ID}}')">
                                            Download
                                        </button>
                                        <button class="text-red-400 hover:underline text-sm" onclick="deleteBackup('{{.ID}}')">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                    </div>
                    {{else}}
                    <div class="text-center py-8 text-gray-400">
                        <p>No backups found. Create your first backup above!</p>
                    </div>
                    {{end}}
                </div>
            </div>
        </main>
    </div>

    <script>
    document.getElementById('backup-settings-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const settings = {
            enabled: formData.get('enable_automatic') === 'on',
            frequency: formData.get('frequency'),
            time: formData.get('time'),
            retention: parseInt(formData.get('retention')),
            encrypted: formData.get('encrypt_backups') === 'on'
        };

        try {
            const response = await fetch('/api/v1/admin/backup/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            if (response.ok) {
                alert('Backup settings saved successfully!');
                location.reload();
            } else {
                throw new Error('Failed to save settings');
            }
        } catch (error) {
            alert('Error saving backup settings: ' + error.message);
        }
    });

    document.getElementById('manual-backup-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const backupType = document.querySelector('input[name="backup_type"]:checked').value;
        
        if (!confirm(`Create ${backupType} backup now? This may take several minutes.`)) {
            return;
        }

        try {
            const response = await fetch('/api/v1/admin/backup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: backupType })
            });

            const result = await response.json();
            
            if (response.ok) {
                alert(`Backup started successfully! Job ID: ${result.backup_id}`);
                location.reload();
            } else {
                throw new Error(result.error || 'Backup creation failed');
            }
        } catch (error) {
            alert('Error creating backup: ' + error.message);
        }
    });

    function downloadBackup(backupId) {
        window.open(`/api/v1/admin/backup/${backupId}/download`, '_blank');
    }

    async function deleteBackup(backupId) {
        if (!confirm('Are you sure you want to delete this backup? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/v1/admin/backup/${backupId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Backup deleted successfully!');
                location.reload();
            } else {
                throw new Error('Failed to delete backup');
            }
        } catch (error) {
            alert('Error deleting backup: ' + error.message);
        }
    }

    // Enable restore button when backup is selected
    document.getElementById('backup-file').addEventListener('change', function() {
        document.getElementById('restore-backup').disabled = !this.files[0];
    });

    document.getElementById('backup-history').addEventListener('change', function() {
        document.getElementById('restore-backup').disabled = !this.value;
    });

    document.getElementById('restore-backup').addEventListener('click', async function() {
        const confirmText = prompt('Type "CONFIRM" to proceed with restore (THIS WILL OVERWRITE ALL DATA):');
        if (confirmText !== 'CONFIRM') {
            return;
        }

        this.disabled = true;
        this.textContent = 'Restoring...';

        try {
            // Implementation for restore would go here
            alert('Restore functionality to be implemented');
        } catch (error) {
            alert('Restore failed: ' + error.message);
        } finally {
            this.disabled = false;
            this.textContent = 'Restore Backup';
        }
    });
    </script>
</body>
</html>
{{end}}