{{define "admin_import"}}
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Import - CasGists Admin</title>
    <link href="/static/css/tailwind.css" rel="stylesheet">
    <link href="/static/css/app.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="min-h-screen flex">
        <!-- Admin Sidebar -->
        <nav class="w-64 bg-gray-800 border-r border-gray-700">
            <div class="p-6">
                <h2 class="text-xl font-bold text-blue-400">CasGists Admin</h2>
            </div>
            <div class="px-4 space-y-2">
                <a href="/admin/dashboard" class="block px-4 py-2 rounded text-gray-300 hover:bg-gray-700">Dashboard</a>
                <a href="/admin/users" class="block px-4 py-2 rounded text-gray-300 hover:bg-gray-700">Users</a>
                <a href="/admin/organizations" class="block px-4 py-2 rounded text-gray-300 hover:bg-gray-700">Organizations</a>
                <a href="/admin/import" class="block px-4 py-2 rounded bg-blue-600 text-white">Platform Import</a>
                <a href="/admin/backup" class="block px-4 py-2 rounded text-gray-300 hover:bg-gray-700">Backup & Restore</a>
                <a href="/admin/settings" class="block px-4 py-2 rounded text-gray-300 hover:bg-gray-700">Settings</a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <div class="p-8">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold">Platform Import</h1>
                    <p class="text-gray-400 mt-2">Import gists from external platforms like GitHub, GitLab, and others.</p>
                </div>

                <!-- Import Overview -->
                <div class="bg-gray-800 rounded-lg p-6 mb-8">
                    <h3 class="text-xl font-semibold mb-4">üîÑ Import from External Platforms</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <p class="text-gray-300 mb-4">Import your existing gists from other platforms:</p>
                            <ul class="space-y-2 text-sm text-gray-400">
                                <li>‚Ä¢ GitHub Gists</li>
                                <li>‚Ä¢ GitLab Snippets</li>
                                <li>‚Ä¢ Gitea Gists</li>
                                <li>‚Ä¢ Forgejo Gists</li>
                            </ul>
                        </div>
                        <div class="bg-yellow-900 border border-yellow-600 rounded-lg p-4">
                            <h4 class="font-semibold text-yellow-200 mb-2">‚ö†Ô∏è Important</h4>
                            <p class="text-sm text-yellow-300">You'll need API tokens for the platforms you want to import from. These are used securely and not stored.</p>
                        </div>
                    </div>
                </div>

                <!-- Platform Selection -->
                <div class="bg-gray-800 rounded-lg p-6 mb-8">
                    <h3 class="text-xl font-semibold mb-6">üì± Platform Selection</h3>
                    
                    <form id="import-form" class="space-y-6">
                        <!-- GitHub -->
                        <div class="border border-gray-600 rounded-lg p-4">
                            <label class="flex items-center mb-4">
                                <input type="checkbox" name="platforms" value="github" class="mr-3 w-5 h-5">
                                <span class="font-semibold text-lg">GitHub Gists</span>
                            </label>
                            <div class="ml-8 space-y-3 github-config hidden">
                                <div>
                                    <label class="block text-sm font-medium mb-1">API Token</label>
                                    <input type="password" name="github_token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" 
                                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded">
                                    <p class="text-xs text-gray-400 mt-1">
                                        <a href="https://github.com/settings/tokens" target="_blank" class="text-blue-400 hover:underline">Generate token here</a> 
                                        (requires 'gist' scope)
                                    </p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="github_import_type" value="all" checked class="mr-2">
                                        <span class="text-sm">Import all gists</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="github_import_type" value="select" class="mr-2">
                                        <span class="text-sm">Select specific gists</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- GitLab -->
                        <div class="border border-gray-600 rounded-lg p-4">
                            <label class="flex items-center mb-4">
                                <input type="checkbox" name="platforms" value="gitlab" class="mr-3 w-5 h-5">
                                <span class="font-semibold text-lg">GitLab Snippets</span>
                            </label>
                            <div class="ml-8 space-y-3 gitlab-config hidden">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Instance URL</label>
                                    <input type="url" name="gitlab_url" value="https://gitlab.com" 
                                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">API Token</label>
                                    <input type="password" name="gitlab_token" placeholder="glpat-xxxxxxxxxxxxxxxxxxxx" 
                                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded">
                                </div>
                            </div>
                        </div>

                        <!-- Gitea -->
                        <div class="border border-gray-600 rounded-lg p-4">
                            <label class="flex items-center mb-4">
                                <input type="checkbox" name="platforms" value="gitea" class="mr-3 w-5 h-5">
                                <span class="font-semibold text-lg">Gitea Gists</span>
                            </label>
                            <div class="ml-8 space-y-3 gitea-config hidden">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Instance URL</label>
                                    <input type="url" name="gitea_url" placeholder="https://git.example.com" 
                                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">API Token</label>
                                    <input type="password" name="gitea_token" 
                                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded">
                                </div>
                            </div>
                        </div>

                        <!-- Import Options -->
                        <div class="bg-gray-700 rounded-lg p-6">
                            <h4 class="font-semibold mb-4">‚öôÔ∏è Import Options</h4>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" name="preserve_dates" checked class="mr-2">
                                    <span class="text-sm">Preserve original creation dates</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="import_private" checked class="mr-2">
                                    <span class="text-sm">Import as private gists (recommended)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="add_tags" checked class="mr-2">
                                    <span class="text-sm">Add platform tag (github, gitlab, etc.)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="create_backup" checked class="mr-2">
                                    <span class="text-sm">Create backup before import</span>
                                </label>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium mb-2">Import to Organization (optional)</label>
                                <select name="target_organization" class="px-3 py-2 bg-gray-600 border border-gray-500 rounded">
                                    <option value="">Personal Account</option>
                                    {{range .Organizations}}
                                    <option value="{{.Name}}">{{.DisplayName}} ({{.Name}})</option>
                                    {{end}}
                                </select>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex space-x-4">
                            <button type="button" id="test-connections" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">
                                Test Connections
                            </button>
                            <button type="submit" id="start-import" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded text-white" disabled>
                                Start Import
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Discovery Results -->
                <div id="discovery-results" class="bg-gray-800 rounded-lg p-6 hidden mb-8">
                    <h3 class="text-xl font-semibold mb-4">üîç Discovery Results</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-600">
                                    <th class="text-left py-2">Platform</th>
                                    <th class="text-left py-2">Gists Found</th>
                                    <th class="text-left py-2">Size</th>
                                    <th class="text-left py-2">Estimated Time</th>
                                </tr>
                            </thead>
                            <tbody id="discovery-table-body">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Import Progress -->
                <div id="import-progress" class="bg-gray-800 rounded-lg p-6 hidden">
                    <h3 class="text-xl font-semibold mb-4">üîÑ Import in Progress</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Overall Progress</span>
                                <span id="progress-text">0% (estimated 0 minutes left)</span>
                            </div>
                            <div class="w-full bg-gray-600 rounded-full h-2">
                                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-400">Current Platform:</span>
                                <span id="current-platform" class="ml-2 font-medium">-</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Current Gist:</span>
                                <span id="current-gist" class="ml-2 font-medium">-</span>
                            </div>
                        </div>
                        <div class="flex space-x-4">
                            <button id="pause-import" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded text-white">
                                Pause Import
                            </button>
                            <button id="view-log" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                                View Detailed Log
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Import History -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4">üìã Import History</h3>
                    {{if .ImportJobs}}
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-600">
                                    <th class="text-left py-2">Date</th>
                                    <th class="text-left py-2">Platform</th>
                                    <th class="text-left py-2">Items</th>
                                    <th class="text-left py-2">Status</th>
                                    <th class="text-left py-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{range .ImportJobs}}
                                <tr class="border-b border-gray-700">
                                    <td class="py-2">{{.CreatedAt.Format "Jan 2, 2006 15:04"}}</td>
                                    <td class="py-2 capitalize">{{.SourceType}}</td>
                                    <td class="py-2">{{.SuccessfulItems}}/{{.TotalItems}}</td>
                                    <td class="py-2">
                                        {{if eq .Status "completed"}}
                                            <span class="px-2 py-1 bg-green-600 text-green-100 rounded text-xs">‚úÖ Success</span>
                                        {{else if eq .Status "failed"}}
                                            <span class="px-2 py-1 bg-red-600 text-red-100 rounded text-xs">‚ùå Failed</span>
                                        {{else if eq .Status "processing"}}
                                            <span class="px-2 py-1 bg-blue-600 text-blue-100 rounded text-xs">üîÑ Processing</span>
                                        {{else}}
                                            <span class="px-2 py-1 bg-gray-600 text-gray-100 rounded text-xs">{{.Status}}</span>
                                        {{end}}
                                    </td>
                                    <td class="py-2">
                                        <button class="text-blue-400 hover:underline text-sm" onclick="viewImportDetails('{{.ID}}')">
                                            View Details
                                        </button>
                                    </td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                    </div>
                    {{else}}
                    <div class="text-center py-8 text-gray-400">
                        <p>No import jobs found. Start your first import above!</p>
                    </div>
                    {{end}}
                </div>
            </div>
        </main>
    </div>

    <script>
    // Platform configuration toggle
    document.querySelectorAll('input[name="platforms"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const platform = this.value;
            const configDiv = document.querySelector(`.${platform}-config`);
            if (this.checked) {
                configDiv.classList.remove('hidden');
            } else {
                configDiv.classList.add('hidden');
            }
            checkCanStartImport();
        });
    });

    // Test connections
    document.getElementById('test-connections').addEventListener('click', async function() {
        this.disabled = true;
        this.textContent = 'Testing...';
        
        const selectedPlatforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked'));
        if (selectedPlatforms.length === 0) {
            alert('Please select at least one platform first.');
            this.disabled = false;
            this.textContent = 'Test Connections';
            return;
        }

        try {
            const testData = {};
            selectedPlatforms.forEach(platform => {
                const name = platform.value;
                testData[name] = {
                    token: document.querySelector(`input[name="${name}_token"]`).value,
                    url: document.querySelector(`input[name="${name}_url"]`)?.value
                };
            });

            const response = await fetch('/api/v1/admin/import/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(testData)
            });

            const results = await response.json();
            displayDiscoveryResults(results);
            document.getElementById('start-import').disabled = false;

        } catch (error) {
            alert('Connection test failed: ' + error.message);
        } finally {
            this.disabled = false;
            this.textContent = 'Test Connections';
        }
    });

    // Start import
    document.getElementById('start-import').addEventListener('click', async function(e) {
        e.preventDefault();
        
        if (!confirm('Are you sure you want to start the import? This will create new gists in your system.')) {
            return;
        }

        this.disabled = true;
        document.getElementById('import-progress').classList.remove('hidden');
        
        // Collect form data and start import
        // Implementation would go here
    });

    function displayDiscoveryResults(results) {
        const tbody = document.getElementById('discovery-table-body');
        tbody.innerHTML = '';
        
        let totalGists = 0;
        let totalTime = 0;

        Object.entries(results).forEach(([platform, data]) => {
            if (data.success) {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700';
                row.innerHTML = `
                    <td class="py-2 capitalize">${platform}</td>
                    <td class="py-2">${data.gist_count}</td>
                    <td class="py-2">${data.total_size}</td>
                    <td class="py-2">${data.estimated_time}</td>
                `;
                tbody.appendChild(row);
                
                totalGists += data.gist_count;
                totalTime += data.estimated_time_minutes;
            }
        });

        // Add total row
        const totalRow = document.createElement('tr');
        totalRow.className = 'border-b border-gray-700 font-semibold bg-gray-700';
        totalRow.innerHTML = `
            <td class="py-2">Total</td>
            <td class="py-2">${totalGists}</td>
            <td class="py-2">-</td>
            <td class="py-2">${totalTime}-${totalTime + 5} minutes</td>
        `;
        tbody.appendChild(totalRow);

        document.getElementById('discovery-results').classList.remove('hidden');
    }

    function checkCanStartImport() {
        const hasSelection = document.querySelectorAll('input[name="platforms"]:checked').length > 0;
        document.getElementById('test-connections').disabled = !hasSelection;
    }

    function viewImportDetails(jobId) {
        // Open modal or navigate to details page
        window.open(`/admin/import/jobs/${jobId}`, '_blank');
    }
    </script>
</body>
</html>
{{end}}