{{template "base" .}}

{{define "title"}}Create Administrator Account - CasGists{{end}}

{{define "content"}}
<div class="min-h-screen flex items-center justify-center bg-gray-900 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <div>
            <h2 class="mt-6 text-center text-3xl font-extrabold text-white">
                üéâ Welcome to CasGists!
            </h2>
            <p class="mt-2 text-center text-sm text-gray-400">
                You're the first user on this server. To complete the setup,<br>
                we need to create a separate administrator account for server management.
            </p>
        </div>
        
        <form id="admin-form" class="mt-8 space-y-6" onsubmit="handleAdminCreation(event)">
            <div class="rounded-md shadow-sm -space-y-px">
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-medium text-white mb-4">
                        Create Administrator Account
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-300">
                                Username
                            </label>
                            <input id="username" 
                                   name="username" 
                                   type="text" 
                                   required 
                                   value="administrator"
                                   pattern="[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]"
                                   minlength="3"
                                   maxlength="39"
                                   class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-700 bg-gray-900 placeholder-gray-500 text-white rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                                   placeholder="administrator">
                            <p class="mt-1 text-xs text-gray-400">Default: administrator (can be changed)</p>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-300">
                                Password Options
                            </label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" 
                                           name="password_option" 
                                           value="generate" 
                                           checked
                                           onchange="togglePasswordFields()"
                                           class="mr-2 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-300">Generate secure password</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" 
                                           name="password_option" 
                                           value="custom"
                                           onchange="togglePasswordFields()"
                                           class="mr-2 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-300">Custom password</span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="custom-password-fields" class="space-y-4 hidden">
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-300">
                                    Password
                                </label>
                                <input id="password" 
                                       name="password" 
                                       type="password" 
                                       minlength="12"
                                       class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-700 bg-gray-900 placeholder-gray-500 text-white rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                                       placeholder="Minimum 12 characters">
                            </div>
                            <div>
                                <label for="confirm_password" class="block text-sm font-medium text-gray-300">
                                    Confirm Password
                                </label>
                                <input id="confirm_password" 
                                       name="confirm_password" 
                                       type="password" 
                                       minlength="12"
                                       class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-700 bg-gray-900 placeholder-gray-500 text-white rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                                       placeholder="Confirm password">
                            </div>
                            
                            <div class="text-xs text-gray-400 space-y-1">
                                <p>Requirements:</p>
                                <ul class="list-disc list-inside ml-2">
                                    <li id="req-length" class="text-red-400">‚úó 12+ characters</li>
                                    <li id="req-uppercase" class="text-red-400">‚úó Uppercase letter</li>
                                    <li id="req-lowercase" class="text-red-400">‚úó Lowercase letter</li>
                                    <li id="req-number" class="text-red-400">‚úó Number</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div id="generate-warning" class="p-3 bg-yellow-900 border border-yellow-700 rounded-md">
                            <p class="text-sm text-yellow-300">
                                ‚ö†Ô∏è Generated password will only be shown once - copy it immediately!
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <button type="submit" 
                        id="submit-button"
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Create Admin Account & Continue Setup
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Generated Password Modal -->
<div id="password-modal" class="hidden fixed z-10 inset-0 overflow-y-auto">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-900 opacity-75"></div>
        </div>
        
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        
        <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-white" id="modal-title">
                            Administrator Account Created!
                        </h3>
                        <div class="mt-4">
                            <p class="text-sm text-gray-300 mb-4">
                                ‚úÖ Administrator account created successfully!
                            </p>
                            <div class="bg-gray-900 p-4 rounded-md">
                                <p class="text-sm text-gray-400 mb-2">Username:</p>
                                <p class="text-white font-mono mb-4" id="admin-username"></p>
                                
                                <p class="text-sm text-gray-400 mb-2">Generated Password:</p>
                                <div class="flex items-center space-x-2">
                                    <input type="text" 
                                           id="generated-password" 
                                           readonly 
                                           class="flex-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded-md font-mono text-sm text-white">
                                    <button type="button"
                                            onclick="copyPassword()"
                                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                                        Copy
                                    </button>
                                </div>
                            </div>
                            <div class="mt-4 p-3 bg-red-900 border border-red-700 rounded-md">
                                <p class="text-sm text-red-300">
                                    ‚ö†Ô∏è Copy this password now! It won't be shown again.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" 
                        onclick="continueToSetup()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Continue to Setup Wizard
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle password fields based on radio selection
function togglePasswordFields() {
    const option = document.querySelector('input[name="password_option"]:checked').value;
    const customFields = document.getElementById('custom-password-fields');
    const generateWarning = document.getElementById('generate-warning');
    const passwordField = document.getElementById('password');
    const confirmField = document.getElementById('confirm_password');
    
    if (option === 'custom') {
        customFields.classList.remove('hidden');
        generateWarning.classList.add('hidden');
        passwordField.setAttribute('required', '');
        confirmField.setAttribute('required', '');
    } else {
        customFields.classList.add('hidden');
        generateWarning.classList.remove('hidden');
        passwordField.removeAttribute('required');
        confirmField.removeAttribute('required');
    }
}

// Password validation
document.getElementById('password').addEventListener('input', function(e) {
    const password = e.target.value;
    
    // Length check
    document.getElementById('req-length').className = 
        password.length >= 12 ? 'text-green-400' : 'text-red-400';
    document.getElementById('req-length').textContent = 
        (password.length >= 12 ? '‚úì' : '‚úó') + ' 12+ characters';
    
    // Uppercase check
    document.getElementById('req-uppercase').className = 
        /[A-Z]/.test(password) ? 'text-green-400' : 'text-red-400';
    document.getElementById('req-uppercase').textContent = 
        (/[A-Z]/.test(password) ? '‚úì' : '‚úó') + ' Uppercase letter';
    
    // Lowercase check
    document.getElementById('req-lowercase').className = 
        /[a-z]/.test(password) ? 'text-green-400' : 'text-red-400';
    document.getElementById('req-lowercase').textContent = 
        (/[a-z]/.test(password) ? '‚úì' : '‚úó') + ' Lowercase letter';
    
    // Number check
    document.getElementById('req-number').className = 
        /[0-9]/.test(password) ? 'text-green-400' : 'text-red-400';
    document.getElementById('req-number').textContent = 
        (/[0-9]/.test(password) ? '‚úì' : '‚úó') + ' Number';
});

// Handle form submission
async function handleAdminCreation(event) {
    event.preventDefault();
    
    const form = event.target;
    const submitButton = document.getElementById('submit-button');
    const option = document.querySelector('input[name="password_option"]:checked').value;
    
    // Validate custom password
    if (option === 'custom') {
        const password = form.password.value;
        const confirm = form.confirm_password.value;
        
        if (password !== confirm) {
            alert('Passwords do not match');
            return;
        }
        
        if (password.length < 12 || !/[A-Z]/.test(password) || 
            !/[a-z]/.test(password) || !/[0-9]/.test(password)) {
            alert('Password does not meet requirements');
            return;
        }
    }
    
    // Disable button and show loading
    submitButton.disabled = true;
    submitButton.textContent = 'Creating account...';
    
    try {
        const response = await fetch('/api/v1/setup/create-admin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                username: form.username.value,
                generate_password: option === 'generate',
                password: option === 'custom' ? form.password.value : undefined,
                confirm_password: option === 'custom' ? form.confirm_password.value : undefined
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to create admin account');
        }
        
        const data = await response.json();
        
        // Store auto-login token
        sessionStorage.setItem('auto_login_token', data.auto_login_token);
        
        // Show success modal
        document.getElementById('admin-username').textContent = data.username;
        
        if (data.generated_password) {
            document.getElementById('generated-password').value = data.generated_password;
            document.getElementById('password-modal').classList.remove('hidden');
        } else {
            // If custom password, go directly to setup
            continueToSetup();
        }
        
    } catch (error) {
        alert('Error: ' + error.message);
        submitButton.disabled = false;
        submitButton.textContent = 'Create Admin Account & Continue Setup';
    }
}

// Copy password to clipboard
function copyPassword() {
    const passwordInput = document.getElementById('generated-password');
    passwordInput.select();
    document.execCommand('copy');
    
    // Visual feedback
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Copied!';
    button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    button.classList.add('bg-green-600');
    
    setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('bg-green-600');
        button.classList.add('bg-blue-600', 'hover:bg-blue-700');
    }, 2000);
}

// Continue to setup wizard
async function continueToSetup() {
    // Perform auto-login
    const token = sessionStorage.getItem('auto_login_token');
    
    try {
        const response = await fetch('/api/v1/setup/auto-login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                token: token
            })
        });
        
        if (!response.ok) {
            throw new Error('Auto-login failed');
        }
        
        const data = await response.json();
        
        // Store JWT tokens
        localStorage.setItem('access_token', data.access_token);
        localStorage.setItem('refresh_token', data.refresh_token);
        
        // Clear auto-login token
        sessionStorage.removeItem('auto_login_token');
        
        // Redirect to setup wizard
        window.location.href = '/admin/setup/wizard';
        
    } catch (error) {
        console.error('Auto-login error:', error);
        // Fallback to manual login
        window.location.href = '/auth/login?redirect=/admin/setup/wizard';
    }
}
</script>
{{end}}