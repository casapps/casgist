{{define "gist_view"}}
{{template "base" .}}
{{end}}

{{define "head"}}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css" media="(prefers-color-scheme: dark)">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css" media="(prefers-color-scheme: light)">
<style>
    .hljs {
        background: transparent !important;
    }
    pre {
        position: relative;
        padding: 0 !important;
        margin: 0 !important;
    }
    pre code {
        display: block;
        padding: 1rem !important;
        overflow-x: auto;
    }
    .line {
        display: inline-block;
        width: 100%;
        padding: 0 1rem;
        line-height: 1.5;
    }
    .line:hover {
        background-color: rgba(59, 130, 246, 0.1);
    }
    .line::before {
        content: attr(data-line-number);
        display: inline-block;
        width: 3em;
        margin-left: -1rem;
        margin-right: 1rem;
        text-align: right;
        color: #6b7280;
        user-select: none;
        font-size: 0.875rem;
    }
    @media (prefers-color-scheme: dark) {
        .line::before {
            color: #9ca3af;
        }
    }
</style>
{{end}}

{{define "content"}}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Gist Header -->
    <div class="mb-6">
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                    {{if .Gist.Title}}{{.Gist.Title}}{{else}}Untitled Gist{{end}}
                </h1>
                {{if .Gist.Description}}
                <p class="mt-2 text-gray-600 dark:text-gray-300">{{.Gist.Description}}</p>
                {{end}}
                
                <div class="mt-4 flex items-center space-x-6 text-sm text-gray-500 dark:text-gray-400">
                    <a href="/users/{{.Gist.User.Username}}" class="flex items-center hover:text-indigo-600 dark:hover:text-indigo-400">
                        <img class="h-6 w-6 rounded-full mr-2" src="{{.Gist.User.AvatarURL}}" alt="{{.Gist.User.Username}}">
                        {{.Gist.User.Username}}
                    </a>
                    <span>
                        <i class="fas fa-clock mr-1"></i>
                        Created {{.Gist.CreatedAt.Format "Jan 2, 2006"}}
                    </span>
                    <span>
                        <i class="fas fa-edit mr-1"></i>
                        Updated {{.Gist.UpdatedAt.Format "Jan 2, 2006"}}
                    </span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        {{if eq .Gist.Visibility "public"}}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200{{end}}
                        {{if eq .Gist.Visibility "unlisted"}}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200{{end}}
                        {{if eq .Gist.Visibility "private"}}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200{{end}}">
                        <i class="fas fa-{{if eq .Gist.Visibility "public"}}globe{{else if eq .Gist.Visibility "unlisted"}}link{{else}}lock{{end}} mr-1"></i>
                        {{.Gist.Visibility}}
                    </span>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="ml-4 flex items-center space-x-2">
                {{if .IsOwner}}
                <a href="/gists/{{.Gist.ID}}/edit" class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-edit mr-2"></i> Edit
                </a>
                {{else}}
                <button hx-post="/api/v1/gists/{{.Gist.ID}}/fork" 
                        hx-ext="json-enc"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-code-branch mr-2"></i> Fork
                </button>
                {{end}}
                
                <button id="star-btn" 
                        hx-post="/api/v1/gists/{{.Gist.ID}}/star" 
                        hx-swap="outerHTML"
                        class="inline-flex items-center px-3 py-2 border text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500
                        {{if .IsStarred}}border-yellow-400 text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900{{else}}border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700{{end}}">
                    <i class="fas fa-star mr-2"></i> 
                    <span id="star-count">{{.Gist.StarCount}}</span>
                </button>
                
                <button onclick="copyGistUrl()" class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-link mr-2"></i> Copy URL
                </button>
                
                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open" class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-download mr-2"></i> Download
                        <i class="fas fa-chevron-down ml-2"></i>
                    </button>
                    <div x-show="open" @click.away="open = false" x-transition
                         class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 z-10">
                        <div class="py-1">
                            <a href="/gists/{{.Gist.ID}}/download/zip" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-file-archive mr-2"></i> Download ZIP
                            </a>
                            <a href="/gists/{{.Gist.ID}}/git" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-code-branch mr-2"></i> Clone via Git
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Files -->
    <div class="space-y-4">
        {{range .Gist.Files}}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-file-code text-gray-400 mr-2"></i>
                    <span class="font-medium text-gray-900 dark:text-white">{{.Filename}}</span>
                    {{if .Language}}
                    <span class="ml-2 text-sm text-gray-500 dark:text-gray-400">{{.Language}}</span>
                    {{end}}
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="copyFileContent('{{.ID}}')" class="text-sm text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                        <i class="fas fa-copy mr-1"></i> Copy
                    </button>
                    <a href="/gists/{{$.Gist.ID}}/raw/{{.Filename}}" class="text-sm text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                        <i class="fas fa-file-alt mr-1"></i> Raw
                    </a>
                </div>
            </div>
            <div class="relative">
                <pre class="overflow-x-auto"><code id="file-{{.ID}}" class="language-{{.Language}}">{{.Content}}</code></pre>
            </div>
        </div>
        {{end}}
    </div>
    
    <!-- Comments Section -->
    <div class="mt-8 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
            Comments ({{len .Comments}})
        </h3>
        
        {{if .User}}
        <!-- Add Comment Form -->
        <form hx-post="/api/v1/gists/{{.Gist.ID}}/comments" hx-ext="json-enc" hx-target="#comments-list" hx-swap="afterbegin" class="mb-6">
            <textarea name="content" rows="3" required
                      class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                      placeholder="Write a comment..."></textarea>
            <div class="mt-2 flex justify-end">
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-comment mr-2"></i> Comment
                </button>
            </div>
        </form>
        {{end}}
        
        <!-- Comments List -->
        <div id="comments-list" class="space-y-4">
            {{range .Comments}}
            <div class="flex space-x-3">
                <img class="h-8 w-8 rounded-full" src="{{.User.AvatarURL}}" alt="{{.User.Username}}">
                <div class="flex-1">
                    <div class="flex items-center">
                        <a href="/users/{{.User.Username}}" class="font-medium text-gray-900 dark:text-white hover:text-indigo-600 dark:hover:text-indigo-400">
                            {{.User.Username}}
                        </a>
                        <span class="ml-2 text-sm text-gray-500 dark:text-gray-400">
                            {{.CreatedAt.Format "Jan 2, 2006 3:04 PM"}}
                        </span>
                    </div>
                    <div class="mt-1 text-gray-700 dark:text-gray-300">
                        {{.Content}}
                    </div>
                    {{if eq .UserID $.User.ID}}
                    <button hx-delete="/api/v1/gists/{{$.Gist.ID}}/comments/{{.ID}}" 
                            hx-confirm="Are you sure you want to delete this comment?"
                            hx-target="closest div"
                            hx-swap="outerHTML"
                            class="mt-1 text-sm text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">
                        <i class="fas fa-trash mr-1"></i> Delete
                    </button>
                    {{end}}
                </div>
            </div>
            {{end}}
        </div>
        
        {{if not .Comments}}
        <p class="text-center text-gray-500 dark:text-gray-400">No comments yet. Be the first to comment!</p>
        {{end}}
    </div>
</div>
{{end}}

{{define "scripts"}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<!-- Add more language support -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/swift.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/kotlin.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/scala.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/r.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/julia.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/dockerfile.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/makefile.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/nginx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/toml.min.js"></script>

<script>
// Configure highlight.js
hljs.configure({
    ignoreUnescapedHTML: true
});

// Syntax highlighting with line numbers
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('pre code').forEach((block) => {
        // Highlight the code
        hljs.highlightElement(block);
        
        // Add line numbers
        const lines = block.innerHTML.split('\n');
        const numberedLines = lines.map((line, index) => {
            return `<span class="line" data-line-number="${index + 1}">${line}</span>`;
        }).join('\n');
        block.innerHTML = numberedLines;
        block.classList.add('line-numbers');
    });
});

// Copy gist URL
function copyGistUrl() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        showToast('URL copied to clipboard!');
    });
}

// Copy file content
function copyFileContent(fileId) {
    const content = document.getElementById(`file-${fileId}`).textContent;
    navigator.clipboard.writeText(content).then(() => {
        showToast('Content copied to clipboard!');
    });
}

// Show toast notification
function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-md shadow-lg z-50';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Handle star toggle
htmx.on("htmx:afterRequest", function(evt) {
    if (evt.detail.pathInfo.path.includes('/star')) {
        // Toggle star appearance
        const btn = document.getElementById('star-btn');
        const starCount = document.getElementById('star-count');
        
        if (evt.detail.xhr.status === 201) {
            // Starred
            btn.classList.add('border-yellow-400', 'text-yellow-600', 'dark:text-yellow-400', 'bg-yellow-50', 'dark:bg-yellow-900');
            btn.classList.remove('border-gray-300', 'dark:border-gray-600', 'text-gray-700', 'dark:text-gray-200', 'bg-white', 'dark:bg-gray-800');
            starCount.textContent = parseInt(starCount.textContent) + 1;
        } else if (evt.detail.xhr.status === 204) {
            // Unstarred
            btn.classList.remove('border-yellow-400', 'text-yellow-600', 'dark:text-yellow-400', 'bg-yellow-50', 'dark:bg-yellow-900');
            btn.classList.add('border-gray-300', 'dark:border-gray-600', 'text-gray-700', 'dark:text-gray-200', 'bg-white', 'dark:bg-gray-800');
            starCount.textContent = Math.max(0, parseInt(starCount.textContent) - 1);
        }
    }
});
</script>
{{end}}